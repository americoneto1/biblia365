---
import Layout from '@/src/layouts/Layout.astro'
import { getVerseOfDay, months } from '@/src/shared/services/bible';
import { Icon } from 'astro-icon/components'

export const formatDate = function(dayOrMonth: number) {
  return dayOrMonth.toString().padStart(2, '0');
}

export const getDates = function(day: number, month: number) {
  const nextDate = new Date(2025, month - 1, day);
  nextDate.setDate(nextDate.getDate() + 1);
  const prevDate = new Date(2025, month - 1, day);
  prevDate.setDate(prevDate.getDate() - 1);

  return {
    nextDate: {
      day: formatDate(nextDate.getDate()),
      month: formatDate(nextDate.getMonth() + 1)
    },
    prevDate: {
      day: formatDate(prevDate.getDate()),
      month: formatDate(prevDate.getMonth() + 1)
    }
  }
}

export async function getStaticPaths() {
  const pages: { params: { version: string; day: string; month: string; part: string; }; }[] = [];
  const versions = ['naa'];
  const parts = ['at', 'nt', 'sl', 'pv'];

  for (let month = 1; month <= 12; month++) {
    const daysOfMonth = month === 2 ? 28 : (month === 1 || month === 3 || month === 5 || month === 7 || month === 8 || month === 10 || month === 12 ) ? 31 : 30
    for (let day = 1; day <= daysOfMonth; day++) {
      versions.forEach(version => {
        parts.forEach(part => {
          pages.push({ params: {
            version: version,
            day: formatDate(day),
            month: formatDate(month),
            part
          }});
        });
      });
    }
  }

  return pages;
}

const { version, month, day, part } = Astro.params;

const result = getVerseOfDay(month, day, part)
const dates = getDates(parseInt(day), parseInt(month))
const basePath = `/${version}/${month}/${day}/`

// Get all 4 daily readings for WhatsApp share
const atReading = getVerseOfDay(month, day, 'at');
const ntReading = getVerseOfDay(month, day, 'nt');
const slReading = getVerseOfDay(month, day, 'sl');
const pvReading = getVerseOfDay(month, day, 'pv');

// Calculate day of year (día do año)
const dayOfYear = Math.floor((new Date(2025, parseInt(month) - 1, parseInt(day)).getTime() - new Date(2025, 0, 0).getTime()) / 86400000);

// Build share text for WhatsApp
const pageUrl = `${Astro.url.origin}/${version}/${month}/${day}/at`;
const shareText = `*Dia ${dayOfYear}:*
${atReading?.title || ''}
${ntReading?.title || ''}
${slReading?.title || ''}
${pvReading?.title || ''}

${pageUrl}

*Reflexão:* 
digite_aqui
`;

const whatsappLink = `https://wa.me/?text=${encodeURIComponent(shareText)}`;

const sections = [
  {
    name: 'AT',
    link: basePath + 'at',
    active: part === 'at'
  },
  {
    name: 'NT',
    link: basePath + 'nt',
    active: part === 'nt'
  },
  {
    name: 'Salmos',
    link: basePath + 'sl',
    active: part === 'sl'
  },
  {
    name: 'Provérbios',
    link: basePath + 'pv',
    active: part === 'pv'
  },
]
---

<Layout>
  <header class="fixed top-0 bg-background w-full">
    <nav class="flex justify-between items-center">
      <a class="ml-4" title="voltar" href={ `/${version}/${dates.prevDate.month}/${dates.prevDate.day}/at` }>
        <Icon name="mdi:arrow-left" size="24" />
      </a>
      <strong class="text-xl text-center p-4">{day} de {months[parseInt(month) - 1]}</strong>
      <a class="mr-4" title="avançar" href={ `/${version}/${dates.nextDate.month}/${dates.nextDate.day}/at` }>
        <Icon name="mdi:arrow-right" size="24" />
      </a>
    </nav>

    <div class="flex items-center justify-between p-4">
      <div class="flex items-center">
        <div class="inline-flex items-center gap-2" role="group" aria-label="Ajustar tamanho da fonte">
          <button id="font-decrease" data-font-action="decrease" class="border border-blue-700 text-blue-700 bg-transparent px-2 py-1 rounded-full text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-300" title="Diminuir fonte">A-</button>
          <button id="font-increase" data-font-action="increase" class="border border-blue-700 text-blue-700 bg-transparent px-2 py-1 rounded-full text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-300" title="Aumentar fonte">A+</button>
        </div>
      </div>

      <div class="flex items-center">
        <div class="inline-flex items-center gap-2" role="group" aria-label="Ajustar tamanho da fonte">
          {sections.map(item => (
            <div class={ item.active ? 'rounded-2xl bg-blue-500 text-white' : 'rounded-2xl bg-gray-200 text-blue-700'}>
              <a class="block px-2 py-1 text-sm" href={ item.link }>{ item.name }</a>
            </div>
          ))}
        </div>
      </div>
    </div>
  </header>

  <article class="pt-14 p-4 mt-20">
    <div class="flex items-center justify-between mb-2">
      <strong class="text-xl block font-semibold">{result?.title}</strong>
      <a href={whatsappLink} target="_blank" rel="noopener noreferrer" title="Compartilhar no WhatsApp" class="border border-green-500 text-white bg-green-500 px-1 py-1 rounded-full">
        <Icon name="mdi:whatsapp" size="20" />
      </a>
    </div>
    {result?.content.map(item => (
      <p class=""><small class="text-xs">{item.chapter}.{item.verse}</small> {item.text}</p>
    ))}
  </article>
</Layout>